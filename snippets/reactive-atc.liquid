{% liquid
  assign selected_variant = product.selected_or_first_available_variant
  assign hundred_product = all_products['100-premium-blades']
  assign lifetime_product = all_products['blades-for-life']
%}

<style>
  [x-cloak] {
    display: none !important;
  }
</style>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

{% assign selling_points = product.metafields.custom.selling_points.value %}

{% if selling_points %}
  <ul class="list-none pl-0">
    {% for point in selling_points %}
      <li>âœ… {{ point }}</li>
    {% endfor %}
  </ul>
{% endif %}


{% if product.variants.size > 1 %}
  <div x-data>
    <div class="mb-2">
      Package:
      <span x-html="$store.pdpExtra.variantTitle"></span>
    </div>
    <div class="flex gap-2 flex-wrap">
      {% for variant in product.variants %}
        <button
          @click="$store.pdpExtra.selectedVariant = '{{ variant.id }}'; $store.pdpExtra.variantPrice = '{{ variant.price | money }}'; $store.pdpExtra.variantCompareAtPrice = '{{ variant.compare_at_price | money }}'; $store.pdpExtra.variantTitle = '{{ variant.title }}';"
          class="p-0 border-2 border-solid bg-white rounded-full py-2 px-3 flex items-center justify-center cursor-pointer font-semibold"
          :class="$store.pdpExtra.selectedVariant === '{{ variant.id }}' ? 'bg-[#0F172A] text-white' : 'bg-white text-[#0F172A]'">
          {{ variant.title }}
        </button>
      {% endfor %}
    </div>
  </div>
{% endif %}

<div x-data class="flex items-center gap-2">
  <div class="text-xl text-black" x-html="$store.pdpExtra.variantPrice">{{ product.price | money }}</div>
  {% if product.price < product.compare_at_price %}
    <div class="text-gray-500 line-through" x-html="$store.pdpExtra.variantCompareAtPrice">
      {{ product.compare_at_price | money }}
    </div>
  {% endif %}
</div>


<product-form
  class="product-form"
  data-hide-errors="{{ gift_card_recipient_feature_active }}"
  data-section-id="{{ section.id }}">
  {%- form 'product'
    , product
    , id: ''
    , class: 'form'
    , novalidate: 'novalidate'
    , data-type: 'add-to-cart-form'
  -%}
    <input
      x-data
      type="hidden"
      name="id"
      id="product-variant-id"
      :value="$store.pdpExtra.selectedVariant"
      class="product-variant-id">
    <button
      type="submit"
      name="add"
      value="1"
      class="hidden_product_form_submit button button--full-width"
      aria-label="Add to cart">
      <span>Add to cart</span>
      {%- render 'loading-spinner' -%}
    </button>
  {%- endform -%}
</product-form>


{% assign accessories = product.metafields.custom.accessories.value %}
{% if accessories %}
  <div x-data class="p-4 pb-6">
    <h3 class="text-lg font-semibold !my-0">Accessories:</h3>
    <p class="text-base mt-0 !mb-3">Accessories 20% off until {{ 'now' | date: "%s" | plus: 259200 | date: "%b %d" }} - Automatically applies in the cart.</p>
    {% for item in accessories %}
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-1">
          <input
            class="!size-5 m-0"
            id="{{ item.id }}"
            type="checkbox"
            :checked="$store.pdpExtra.accessories.includes('{{ item.selected_or_first_available_variant.id }}')"
            @change="$store.pdpExtra.addRemoveAccessories('{{ item.selected_or_first_available_variant.id }}')">
          <label for="{{ item.id }}">{{ item.title }}</label>
        </div>
        <div class="flex items-center gap-2">
          <span class="whitespace-nowrap">+{{ item.price | money }}</span>
          <button @click="$store.pdpExtra.showModal = true; $store.pdpExtra.modalContentId = '{{ item.title | downcase | replace: ' ', '_' }}'" class="border-0 p-0 bg-transparent flex text-gray-700 cursor-pointer">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="feather feather-help-circle">
              <circle
                cx="12"
                cy="12"
                r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line
                x1="12"
                y1="17"
                x2="12.01"
                y2="17"></line>
            </svg>
          </button>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

<script>

    const modalContents = {
      {% for pa in accessories %}
        "{{ pa.title | downcase | replace: ' ', '_' }}": {
          "image": "{{ pa.images.first | image_url: width: 450 }}",
          "title": "{{ pa.title }}",
          "content": `{{ pa.description }}`
        },
      {% endfor %}
      "{{ hundred_product.title |  downcase |  replace: ' ', '_' }}": {
        "image": "{{ hundred_product.images.first | image_url: width: 450 }}",
        "title": "{{ hundred_product.title }}",
        "content": `{{ hundred_product.description }}`
      },
      "{{ lifetime_product.title |  downcase |  replace: ' ', '_' }}": {
        "image": "{{ lifetime_product.images.first | image_url: width: 450 }}",
        "title": "{{ lifetime_product.title }}",
        "content": `{{ lifetime_product.description }}`
      }
    };

    document.addEventListener('alpine:init', () => {
        Alpine.store('pdpExtra', {
            selectedVariant: "{{ selected_variant.id }}",
            variantPrice: "{{ selected_variant.price | money }}",
            variantCompareAtPrice: "{{ selected_variant.compare_at_price | money }}",
            variantTitle: "{{ selected_variant.title }}",
            bladeOption: "",
            accessories: [],
            addingToCart: false,
            showModal: false,
            modalContentId: "",
            get modalImage () {
              return modalContents[this.modalContentId].image;
            },
            get modalTitle () {
              return modalContents[this.modalContentId].title;
            },
            get modalContent () {
              return modalContents[this.modalContentId].content;
            },
            addRemoveAccessories (id) {
                if (this.accessories.includes(id)) {
                    this.accessories = this.accessories.filter((item) => item !== id);
                } else {
                    this.accessories.push(id);
                }
            },
        })
    })
</script>